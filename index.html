<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>姿勢撮影（Safari用）</title>

  <!-- MediaPipe Pose -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <style>
    body { margin: 0; }
    #container {
      position: relative;
      width: 600px;
      height: 800px;
    }
    video, canvas {
      position: absolute;
      top: 0;
      left: 0;
    }
  </style>
</head>

<body>

<h3>背面カメラで姿勢撮影</h3>

<div id="container">
  <video id="video" autoplay playsinline width="600" height="800"></video>
  <canvas id="canvas" width="600" height="800"></canvas>
</div>

<script>
async function main() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: {
      facingMode: { exact: "environment" }, // ← Safariならほぼ確実
      width: { ideal: 600 },
      height: { ideal: 800 }
    },
    audio: false
  });

  const video = document.getElementById("video");
  video.srcObject = stream;

  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  const pose = new Pose({
    locateFile: file =>
      `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
  });

  pose.setOptions({
    modelComplexity: 0,
    smoothLandmarks: true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  pose.onResults(results => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (results.poseLandmarks) {
      drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS,
        { color: '#00FF00', lineWidth: 3 });
      drawLandmarks(ctx, results.poseLandmarks,
        { color: '#FF0000', lineWidth: 2 });
    }
  });

  const camera = new Camera(video, {
    onFrame: async () => {
      await pose.send({ image: video });
    },
    width: 600,
    height: 800
  });

  camera.start();
}

main();
</script>

</body>
</html>
