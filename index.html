<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>姿勢撮影</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body>

<h3 id="status">準備中...</h3>

<video id="video" autoplay playsinline width="600" height="800"></video>
<canvas id="canvas" width="600" height="800"
        style="position:absolute; top:80px; left:0;"></canvas>

<script>
async function main() {
  await liff.init({ liffId: "2008850895-GKh4kFcG" });

  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  const stream = await navigator.mediaDevices.getUserMedia({
    video: {
      facingMode: "environment",
      width: { ideal: 600 },
      height: { ideal: 800 }
    },
    audio: false
  });

  video.srcObject = stream;

  document.getElementById("status").innerText = "姿勢推定中";

  const pose = new Pose({
    locateFile: file =>
      `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
  });

  pose.setOptions({
    modelComplexity: 0,      // 軽量
    smoothLandmarks: true,
    enableSegmentation: false,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  pose.onResults(results => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (results.poseLandmarks) {
      drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS,
        { color: '#00FF00', lineWidth: 3 });
      drawLandmarks(ctx, results.poseLandmarks,
        { color: '#FF0000', lineWidth: 2 });
    }
  });

  const camera = new Camera(video, {
    onFrame: async () => {
      await pose.send({ image: video });
    },
    width: 600,
    height: 800
  });


  camera.start();
}

main();
</script>

</body>
</html>
